"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react");function e(){return e=Object.assign||function(t){for(var e=1;arguments.length>e;e++){var i=arguments[e];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])}return t},e.apply(this,arguments)}function i(t,e){if(null==t)return{};var i,s,n=function(t,e){if(null==t)return{};var i,s,n={},h=Object.keys(t);for(s=0;h.length>s;s++)0>e.indexOf(i=h[s])&&(n[i]=t[i]);return n}(t,e);if(Object.getOwnPropertySymbols){var h=Object.getOwnPropertySymbols(t);for(s=0;h.length>s;s++)0>e.indexOf(i=h[s])&&Object.prototype.propertyIsEnumerable.call(t,i)&&(n[i]=t[i])}return n}var s="undefined"!=typeof window&&void 0!==window.ontouchstart,n=function(){},h=function(t){return Math.sqrt(t.x*t.x+t.y*t.y)};function o(t,e){var i=function(t,e){var i=h(t)*h(e);if(0===i)return 0;var s=function(t,e){return t.x*e.x+t.y*e.y}(t,e)/i;return s>1&&(s=1),Math.acos(s)}(t,e);return function(t,e){return t.x*e.y-e.x*t.y}(t,e)>0&&(i*=-1),180*i}var l=function(t){this.handlers=[],this.el=t};function a(t,e){var i=new l(t);return i.add(e),i}l.prototype.add=function(t){this.handlers.push(t)},l.prototype.del=function(t){t||(this.handlers=[]);for(var e=this.handlers.length;e>=0;e--)this.handlers[e]===t&&this.handlers.splice(e,1)},l.prototype.dispatch=function(){for(var t=arguments.length,e=Array(t),i=0;t>i;i++)e[i]=arguments[i];for(var s=0,n=this.handlers.length;n>s;s++){var h,o=this.handlers[s];null===(h=o.apply)||void 0===h||h.call(o,this.el,e)}};var u=function(t,e){this.element=t,this.start=this.start.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.cancel=this.cancel.bind(this),this.element.addEventListener(s?"touchstart":"mousedown",this.start),s?(this.element.addEventListener("touchmove",this.move),this.element.addEventListener("touchend",this.end),this.element.addEventListener("touchcancel",this.cancel)):(document.addEventListener("mousemove",this.move),document.addEventListener("mouseup",this.end)),this.preV={x:null,y:null},this.pinchStartLen=null,this.scale=1,this.isDoubleTap=!1,this.rotate=a(this.element,e.onRotate||n),this.touchStart=a(this.element,e.onTouchStart||n),this.touchMove=a(this.element,e.onTouchMove||n),this.touchEnd=a(this.element,e.onTouchEnd||n),this.touchCancel=a(this.element,e.onTouchCancel||n),this.isMoving=!1,this.multipointStart=a(this.element,e.onMultipointStart||n),this.multipointEnd=a(this.element,e.onMultipointEnd||n),this.pinch=a(this.element,e.onPinch||n),this.swipe=a(this.element,e.onSwipe||n),this.doubleTap=a(this.element,e.onDoubleTap||n),this.longTap=a(this.element,e.onLongTap||n),this.singleTap=a(this.element,e.onSingleTap||n),this.pressMove=a(this.element,e.onPressMove||n),this.twoFingerPressMove=a(this.element,e.onTwoFingerPressMove||n),this._cancelAllHandler=this.cancelAll.bind(this),window.addEventListener("scroll",this._cancelAllHandler),this.delta=null,this.last=null,this.now=null,this.tapTimeout=null,this.singleTapTimeout=null,this.longTapTimeout=null,this.swipeTimeout=null,this.x1=this.x2=this.y1=this.y2=null,this.preTapPosition={x:null,y:null}};u.prototype={start:function(t){t.touches||(t.touches=t.touches||[],t.touches[0]={pageX:t.pageX,pageY:t.pageY}),this.isMoving||(this.isMoving=!0),this.now=Date.now(),this.x1=t.touches[0].pageX,this.y1=t.touches[0].pageY,this.delta=this.now-(this.last||this.now),this.touchStart.dispatch(t,this.element),null!==this.preTapPosition.x&&(this.isDoubleTap=this.delta>0&&250>=this.delta&&30>Math.abs(this.preTapPosition.x-this.x1)&&30>Math.abs(this.preTapPosition.y-this.y1),this.isDoubleTap&&clearTimeout(this.singleTapTimeout)),this.preTapPosition.x=this.x1,this.preTapPosition.y=this.y1,this.last=this.now;var e=this.preV;if(t.touches.length>1){this._cancelLongTap(),this._cancelSingleTap();var i={x:t.touches[1].pageX-this.x1,y:t.touches[1].pageY-this.y1};e.x=i.x,e.y=i.y,this.pinchStartLen=h(e),this.multipointStart.dispatch(t,this.element)}this._preventTap=!1,this.longTapTimeout=setTimeout(function(){this.longTap.dispatch(t,this.element),this._preventTap=!0}.bind(this),750)},move:function(t){var e;if(this.isMoving){t.touches||(t.touches=t.touches||[],t.touches[0]={pageX:t.pageX,pageY:t.pageY});var i=this.preV,s=t.touches.length,n=t.touches[0].pageX,l=t.touches[0].pageY;if(this.isDoubleTap=!1,s>1){var a=t.touches[1].pageX,u=t.touches[1].pageY,r={x:t.touches[1].pageX-n,y:t.touches[1].pageY-l};null!==i.x&&(this.pinchStartLen>0&&(t.scale=h(r)/this.pinchStartLen,this.pinch.dispatch(t,this.element)),t.angle=o(r,i),this.rotate.dispatch(t,this.element)),i.x=r.x,i.y=r.y,null!==this.x2&&null!==this.sx2?(t.deltaX=(n-this.x2+a-this.sx2)/2,t.deltaY=(l-this.y2+u-this.sy2)/2):(t.deltaX=0,t.deltaY=0),this.twoFingerPressMove.dispatch(t,this.element),this.sx2=a,this.sy2=u}else{if(null!==this.x2)t.deltaX=n-this.x2,t.deltaY=l-this.y2,(Math.abs(this.x1-this.x2)>10||Math.abs(this.y1-this.y2)>10)&&(this._preventTap=!0);else t.deltaX=0,t.deltaY=0;this.pressMove.dispatch(t,this.element)}null===(e=this.touchMove)||void 0===e||e.dispatch(t,this.element),this._cancelLongTap(),this.x2=n,this.y2=l,s>1&&t.preventDefault()}},end:function(t){var e;if(this.isMoving&&(this.isMoving=!1),!s||t.changedTouches){t.touches||(t.touches=t.touches||[],t.touches[0]={pageX:t.pageX,pageY:t.pageY}),this._cancelLongTap();var i=this;s&&2>t.touches.length&&(this.multipointEnd.dispatch(t,this.element),this.sx2=this.sy2=null),this.x2&&Math.abs(this.x1-this.x2)>30||this.y2&&Math.abs(this.y1-this.y2)>30?(t.direction=this._swipeDirection(this.x1,this.x2,this.y1,this.y2),this.swipeTimeout=setTimeout((function(){i.swipe.dispatch(t,i.element)}),0)):(this.tapTimeout=setTimeout((function(){var e;i.isDoubleTap&&(null===(e=i.doubleTap)||void 0===e||e.dispatch(t,i.element),i.isDoubleTap=!1)}),0),i.isDoubleTap||(i.singleTapTimeout=setTimeout((function(){var e;i._preventTap||(null===(e=i.singleTap)||void 0===e||e.dispatch(t,i.element))}),250))),null===(e=this.touchEnd)||void 0===e||e.dispatch(t,this.element),this.preV.x=0,this.preV.y=0,this.scale=1,this.pinchStartLen=null,this.x1=this.x2=this.y1=this.y2=null}},cancelAll:function(){this._preventTap=!0,clearTimeout(this.singleTapTimeout),clearTimeout(this.longTapTimeout),clearTimeout(this.swipeTimeout)},cancel:function(t){this.cancelAll(),this.touchCancel.dispatch(t,this.element)},_cancelLongTap:function(){clearTimeout(this.longTapTimeout)},_cancelSingleTap:function(){clearTimeout(this.singleTapTimeout)},_swipeDirection:function(t,e,i,s){return Math.abs(i-s)>Math.abs(t-e)?i-s>0?"up":"down":t-e>0?"left":"right"},on:function(t,e){this[t]&&this[t].add(e)},off:function(t,e){this[t]&&this[t].del(e)},destroy:function(){return this.singleTapTimeout&&clearTimeout(this.singleTapTimeout),this.longTapTimeout&&clearTimeout(this.longTapTimeout),this.swipeTimeout&&clearTimeout(this.swipeTimeout),this.element.removeEventListener(s?"touchstart":"mousedown",this.start),s?(this.element.removeEventListener("touchmove",this.move),this.element.removeEventListener("touchend",this.end),this.element.removeEventListener("touchcancel",this.cancel)):(document.removeEventListener("mousemove",this.move),document.removeEventListener("mouseup",this.end)),this.rotate.del(),this.touchStart.del(),this.multipointStart.del(),this.multipointEnd.del(),this.pinch.del(),this.swipe.del(),this.doubleTap.del(),this.longTap.del(),this.singleTap.del(),this.pressMove.del(),this.twoFingerPressMove.del(),this.touchMove.del(),this.touchEnd.del(),this.touchCancel.del(),this.preV={x:null,y:null},this.isMoving=this.pinchStartLen=this.scale=this.isDoubleTap=this.delta=this.last=this.now=this.singleTapTimeout=this.longTapTimeout=this.swipeTimeout=this.x1=this.x2=this.y1=this.y2=this.preTapPosition=this.rotate=this.touchStart=this.multipointStart=this.multipointEnd=this.pinch=this.swipe=this.doubleTap=this.longTap=this.singleTap=this.pressMove=this.touchMove=this.touchEnd=this.touchCancel=this.twoFingerPressMove=null,window.removeEventListener("scroll",this._cancelAllHandler),null}};var r=["children"],c=function(){throw Error("TouchElement: 子元素必须是dom/forwardRef到dom的组件")},p=t.forwardRef((function(s,n){var h=s.children,o=i(s,r),l=t.useRef(null);return t.useImperativeHandle(n,(function(){return l.current})),t.useLayoutEffect((function(){var t=l.current;t instanceof HTMLElement||c();var e=new u(t,o);return function(){var t;null===(t=e.destroy)||void 0===t||t.call(e)}}),[]),t.isValidElement(h)||c(),t.createElement(h.type,e({},h.props,{ref:l}))}));p.displayName="TouchElement",exports.TouchElement=p,exports.default=u;
